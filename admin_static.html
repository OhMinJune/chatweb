<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê´€ë¦¬ì ì±„íŒ… - ì‹¤ì‹œê°„ ì±„íŒ… ì›¹ì‚¬ì´íŠ¸</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <div class="admin-container">
            <!-- ì‚¬ì´ë“œë°” -->
            <div class="sidebar">
                <div class="sidebar-header">
                    <h2>ê´€ë¦¬ì íŒ¨ë„</h2>
                    <p id="adminName">ê´€ë¦¬ìë‹˜, ì•ˆë…•í•˜ì„¸ìš”!</p>
                    <button onclick="refreshChatrooms()" class="refresh-btn">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
                </div>
                
                <div class="chatroom-list" id="chatroomList">
                    <!-- ì±„íŒ…ë°© ëª©ë¡ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
                </div>
            </div>
            
            <!-- ë©”ì¸ ì½˜í…ì¸  -->
            <div class="main-content">
                <div class="chat-header">
                    <div class="chat-title" id="chatTitle">ì±„íŒ…ë°©ì„ ì„ íƒí•´ì£¼ì„¸ìš”</div>
                    <button class="logout-btn" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
                </div>
                
                <div class="chat-messages" id="chatMessages">
                    <div class="text-center mt-20">
                        <p>ì±„íŒ…ë°©ì„ ì„ íƒí•˜ì—¬ ëŒ€í™”ë¥¼ ì‹œì‘í•˜ì„¸ìš”.</p>
                    </div>
                </div>
                
                <div class="chat-input">
                    <input type="text" id="messageInput" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." disabled>
                    <button class="send-btn" id="sendBtn" onclick="sendMessage()" disabled>ì „ì†¡</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ ë°ì´í„° ê´€ë¦¬
        class ChatManager {
            constructor() {
                this.currentUser = this.loadCurrentUser();
                this.chatrooms = this.loadChatrooms();
                this.messages = this.loadMessages();
                this.currentChatroomId = null;
            }

            loadCurrentUser() {
                const user = localStorage.getItem('chatweb_current_user');
                return user ? JSON.parse(user) : null;
            }

            loadChatrooms() {
                const chatrooms = localStorage.getItem('chatweb_chatrooms');
                if (!chatrooms) {
                    // ê¸°ë³¸ ì±„íŒ…ë°© ë°ì´í„° ìƒì„±
                    const defaultChatrooms = [
                        {
                            id: 1,
                            name: 'ê³ ê°ìƒë‹´ 1',
                            admin_id: 1,
                            guest_id: 2,
                            status: 'active',
                            created_at: new Date().toISOString(),
                            updated_at: new Date().toISOString(),
                            guest_name: 'ê²ŒìŠ¤íŠ¸1'
                        },
                        {
                            id: 2,
                            name: 'ê³ ê°ìƒë‹´ 2',
                            admin_id: 1,
                            guest_id: 3,
                            status: 'active',
                            created_at: new Date().toISOString(),
                            updated_at: new Date().toISOString(),
                            guest_name: 'ê²ŒìŠ¤íŠ¸2'
                        }
                    ];
                    localStorage.setItem('chatweb_chatrooms', JSON.stringify(defaultChatrooms));
                    return defaultChatrooms;
                }
                return JSON.parse(chatrooms);
            }

            loadMessages() {
                const messages = localStorage.getItem('chatweb_messages');
                if (!messages) {
                    // ê¸°ë³¸ ë©”ì‹œì§€ ë°ì´í„° ìƒì„±
                    const defaultMessages = [
                        {
                            id: 1,
                            chatroom_id: 1,
                            sender_id: 2,
                            message: 'ì•ˆë…•í•˜ì„¸ìš”! ë¬¸ì˜ì‚¬í•­ì´ ìˆì–´ì„œ ì—°ë½ë“œë ¸ìŠµë‹ˆë‹¤.',
                            sender_name: 'ê²ŒìŠ¤íŠ¸1',
                            sender_role: 'guest',
                            created_at: new Date(Date.now() - 60000).toISOString()
                        },
                        {
                            id: 2,
                            chatroom_id: 1,
                            sender_id: 1,
                            message: 'ì•ˆë…•í•˜ì„¸ìš”! ì–´ë–¤ ë„ì›€ì´ í•„ìš”í•˜ì‹ ê°€ìš”?',
                            sender_name: 'ê´€ë¦¬ì',
                            sender_role: 'admin',
                            created_at: new Date(Date.now() - 30000).toISOString()
                        },
                        {
                            id: 3,
                            chatroom_id: 2,
                            sender_id: 3,
                            message: 'ì œí’ˆì— ëŒ€í•´ ë¬¸ì˜ë“œë¦¬ê³  ì‹¶ìŠµë‹ˆë‹¤.',
                            sender_name: 'ê²ŒìŠ¤íŠ¸2',
                            sender_role: 'guest',
                            created_at: new Date(Date.now() - 120000).toISOString()
                        },
                        {
                            id: 4,
                            chatroom_id: 2,
                            sender_id: 1,
                            message: 'ë„¤, ì–´ë–¤ ì œí’ˆì— ëŒ€í•´ ê¶ê¸ˆí•˜ì‹ ê°€ìš”?',
                            sender_name: 'ê´€ë¦¬ì',
                            sender_role: 'admin',
                            created_at: new Date(Date.now() - 90000).toISOString()
                        }
                    ];
                    localStorage.setItem('chatweb_messages', JSON.stringify(defaultMessages));
                    return defaultMessages;
                }
                return JSON.parse(messages);
            }

            saveMessages() {
                localStorage.setItem('chatweb_messages', JSON.stringify(this.messages));
            }

            getChatroomsForAdmin(adminId) {
                // ì±„íŒ…ë°© ëª©ë¡ì„ ì—…ë°ì´íŠ¸ ì‹œê°„ ìˆœìœ¼ë¡œ ì •ë ¬
                return this.chatrooms
                    .filter(room => room.admin_id === adminId)
                    .sort((a, b) => new Date(b.updated_at) - new Date(a.updated_at));
            }

            getMessagesForChatroom(chatroomId) {
                return this.messages.filter(msg => msg.chatroom_id === chatroomId);
            }

            addMessage(chatroomId, senderId, message) {
                const users = JSON.parse(localStorage.getItem('chatweb_users') || '[]');
                const sender = users.find(u => u.id === senderId);
                
                const newMessage = {
                    id: Date.now(),
                    chatroom_id: chatroomId,
                    sender_id: senderId,
                    message: message,
                    sender_name: sender ? sender.name : 'ì•Œ ìˆ˜ ì—†ìŒ',
                    sender_role: sender ? sender.role : 'guest',
                    created_at: new Date().toISOString()
                };

                this.messages.push(newMessage);
                this.saveMessages();
                return newMessage;
            }

            updateChatroomTime(chatroomId) {
                const chatroom = this.chatrooms.find(room => room.id === chatroomId);
                if (chatroom) {
                    chatroom.updated_at = new Date().toISOString();
                    localStorage.setItem('chatweb_chatrooms', JSON.stringify(this.chatrooms));
                }
            }
        }

        // ì±„íŒ… ê´€ë¦¬ì ì¸ìŠ¤í„´ìŠ¤ ìƒì„±
        const chatManager = new ChatManager();
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', () => {
            initializeAdmin();
        });
        
        // ê´€ë¦¬ì ì´ˆê¸°í™”
        function initializeAdmin() {
            // ë¡œê·¸ì¸ í™•ì¸
            if (!chatManager.currentUser || chatManager.currentUser.role !== 'admin') {
                window.location.href = 'index_static.html';
                return;
            }

            // ê´€ë¦¬ì ì´ë¦„ í‘œì‹œ
            document.getElementById('adminName').textContent = `${chatManager.currentUser.name}ë‹˜, ì•ˆë…•í•˜ì„¸ìš”!`;
            
            // ì±„íŒ…ë°© ëª©ë¡ ë¡œë“œ
            loadChatrooms();
            
            // ë©”ì‹œì§€ ì…ë ¥ ì´ë²¤íŠ¸
            document.getElementById('messageInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });
        }
        
        // ì±„íŒ…ë°© ëª©ë¡ ë¡œë“œ
        function loadChatrooms() {
            const adminChatrooms = chatManager.getChatroomsForAdmin(chatManager.currentUser.id);
            const chatroomList = document.getElementById('chatroomList');
            chatroomList.innerHTML = '';
            
            if (adminChatrooms.length === 0) {
                chatroomList.innerHTML = '<div class="text-center mt-20"><p>ì±„íŒ…ë°©ì´ ì—†ìŠµë‹ˆë‹¤.</p></div>';
                return;
            }
            
            adminChatrooms.forEach(chatroom => {
                const chatroomItem = document.createElement('div');
                chatroomItem.className = 'chatroom-item';
                chatroomItem.onclick = () => selectChatroom(chatroom.id);
                
                const guestName = chatroom.guest_name || 'ê²ŒìŠ¤íŠ¸';
                const lastUpdate = new Date(chatroom.updated_at).toLocaleString('ko-KR');
                
                chatroomItem.innerHTML = `
                    <div class="chatroom-name">${chatroom.name}</div>
                    <div class="chatroom-guest">${guestName}</div>
                    <div class="chatroom-time">${lastUpdate}</div>
                `;
                
                chatroomList.appendChild(chatroomItem);
            });
        }
        
        // ì±„íŒ…ë°© ì„ íƒ
        function selectChatroom(chatroomId) {
            currentChatroomId = chatroomId;
            
            // UI ì—…ë°ì´íŠ¸
            document.querySelectorAll('.chatroom-item').forEach(item => {
                item.classList.remove('active');
            });
            event.target.closest('.chatroom-item').classList.add('active');
            
            // ì±„íŒ…ë°© ì œëª© ì—…ë°ì´íŠ¸
            const chatroomItem = event.target.closest('.chatroom-item');
            const chatroomName = chatroomItem.querySelector('.chatroom-name').textContent;
            document.getElementById('chatTitle').textContent = chatroomName;
            
            // ë©”ì‹œì§€ ì…ë ¥ í™œì„±í™”
            document.getElementById('messageInput').disabled = false;
            document.getElementById('sendBtn').disabled = false;
            
            // ë©”ì‹œì§€ ë¡œë“œ
            loadMessages(chatroomId);
        }
        
        // ë©”ì‹œì§€ ë¡œë“œ
        function loadMessages(chatroomId) {
            const messages = chatManager.getMessagesForChatroom(chatroomId);
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.innerHTML = '';
            
            messages.forEach(message => {
                displayMessage(message);
            });
            
            // ìŠ¤í¬ë¡¤ì„ ë§¨ ì•„ë˜ë¡œ
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        // ë©”ì‹œì§€ ì „ì†¡
        function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const message = messageInput.value.trim();
            
            if (!message || !currentChatroomId) return;
            
            // ë©”ì‹œì§€ ì¶”ê°€
            const newMessage = chatManager.addMessage(currentChatroomId, chatManager.currentUser.id, message);
            
            // UIì— í‘œì‹œ
            displayMessage(newMessage);
            
            // ì±„íŒ…ë°© ì—…ë°ì´íŠ¸ ì‹œê°„ ê°±ì‹ 
            chatManager.updateChatroomTime(currentChatroomId);
            
            // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
            messageInput.value = '';
        }
        
        // ë©”ì‹œì§€ í‘œì‹œ
        function displayMessage(message) {
            const chatMessages = document.getElementById('chatMessages');
            
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message';
            
            // ë©”ì‹œì§€ê°€ í˜„ì¬ ì‚¬ìš©ì(ê´€ë¦¬ì)ì˜ ê²ƒì¸ì§€ í™•ì¸
            const isOwn = message.sender_role === 'admin';
            if (isOwn) {
                messageDiv.classList.add('own');
            }
            
            const time = new Date(message.created_at).toLocaleTimeString('ko-KR', {
                hour: '2-digit',
                minute: '2-digit'
            });
            
            messageDiv.innerHTML = `
                <div class="message-avatar">
                    ${message.sender_name.charAt(0)}
                </div>
                <div class="message-content">
                    <div class="message-sender">${message.sender_name}</div>
                    <div class="message-text">${message.message}</div>
                    <div class="message-time">${time}</div>
                </div>
            `;
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        // ë¡œê·¸ì•„ì›ƒ
        function logout() {
            localStorage.removeItem('chatweb_current_user');
            window.location.href = 'index_static.html';
        }
    </script>
</body>
</html>
